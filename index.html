<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>돌봄 근무기록</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 14px;
        }
        @media (min-width: 640px) {
            body { font-size: 16px; }
        }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .loading { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 2000; }
        .loading.active { display: block; }
        
        /* 달력 스타일 */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 0.75rem; overflow: hidden; }
        .calendar-day { background: white; min-height: 50px; padding: 4px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .day-header { background: #f9fafb; font-weight: 600; padding: 10px 0; text-align: center; font-size: 0.75rem; border-bottom: 1px solid #e5e7eb; }
        
        /* 출근한 날짜 파란색 원 강조 */
        .attendance-circle { 
            background-color: #3b82f6; 
            color: white !important; 
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
    <div id="loading" class="loading">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
            <p class="text-gray-700 font-medium">데이터 로딩 중...</p>
        </div>
    </div>

    <div class="max-w-6xl mx-auto">
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    <h1 class="text-3xl font-bold text-gray-800">돌봄 근무기록</h1>
                </div>
                <button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-200 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    엑셀
                </button>
            </div>

            <div class="bg-gradient-to-r from-indigo-50 to-blue-50 rounded-xl p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    출퇴근 기록 입력
                </h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">날짜</label>
                        <input type="date" id="dateInput" class="w-full px-3 py-2 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">출근 시간</label>
                        <input type="time" id="startTimeInput" class="w-full px-3 py-2 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">퇴근 시간</label>
                        <input type="time" id="endTimeInput" class="w-full px-3 py-2 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    <div class="flex items-end">
                        <button onclick="addRecord()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 sm:px-6 rounded-lg transition duration-200 flex items-center justify-center gap-2 text-sm sm:text-base">
                            <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            추가
                        </button>
                    </div>
                </div>
            </div>

            <div class="mb-6 sm:mb-8">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 sm:mb-6 gap-3">
                    <h2 class="text-base sm:text-xl font-semibold text-gray-800 flex items-center gap-2">
                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <line x1="18" y1="20" x2="18" y2="10"></line>
                            <line x1="12" y1="20" x2="12" y2="4"></line>
                            <line x1="6" y1="20" x2="6" y2="14"></line>
                        </svg>
                        근무 현황 대시보드
                    </h2>
                    <div class="w-full sm:w-auto">
                        <select id="monthSelect" onchange="updateDashboard()" class="w-full px-3 py-2 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-medium"></select>
                    </div>
                </div>

                <div class="grid grid-cols-2 lg:grid-cols-5 gap-2 sm:gap-4 mb-8">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg sm:rounded-xl p-3 sm:p-6 text-white">
                        <div class="text-xs sm:text-sm font-medium opacity-90 mb-1 sm:mb-2">출근 일수</div>
                        <div class="text-xl sm:text-3xl font-bold" id="monthDays">0일</div>
                    </div>
                    <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-lg sm:rounded-xl p-3 sm:p-6 text-white">
                        <div class="text-xs sm:text-sm font-medium opacity-90 mb-1">지급 예정 급여</div>
                        <div class="text-xs opacity-80 mb-1">(5만원/일)</div>
                        <div class="text-lg sm:text-3xl font-bold" id="expectedSalary">0원</div>
                    </div>
                    <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-lg sm:rounded-xl p-3 sm:p-6 text-white col-span-2 lg:col-span-1">
                        <div class="text-xs sm:text-sm font-medium opacity-90 mb-1 sm:mb-2">총 근무시간</div>
                        <div class="text-xl sm:text-3xl font-bold" id="monthTotalHours">0시간</div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg sm:rounded-xl p-3 sm:p-6 text-white">
                        <div class="text-xs sm:text-sm font-medium opacity-90 mb-1 sm:mb-2">월 일평균</div>
                        <div class="text-xl sm:text-3xl font-bold" id="monthAvgHours">0시간</div>
                    </div>
                    <div class="bg-gradient-to-br from-pink-500 to-pink-600 rounded-lg sm:rounded-xl p-3 sm:p-6 text-white">
                        <div class="text-xs sm:text-sm font-medium opacity-90 mb-1 sm:mb-2">누적 일평균</div>
                        <div class="text-xl sm:text-3xl font-bold" id="cumulativeAvgHours">0시간</div>
                        <div class="text-xs opacity-80 mt-1">2024.12~</div>
                    </div>
                </div>

                <div class="bg-white border border-gray-100 rounded-xl p-4 sm:p-6 mb-8 shadow-sm">
                    <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        <span id="calendarTitle">근무 달력</span>
                    </h3>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>

                <div class="bg-gray-50 rounded-lg sm:rounded-xl p-4 sm:p-6">
                    <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-3 sm:mb-4" id="monthTitle">출근 기록</h3>
                    <div id="recordsList" class="space-y-2 max-h-80 overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="bg-white rounded-xl sm:rounded-2xl shadow-2xl p-6 sm:p-8 max-w-md w-full mx-4">
            <div class="flex items-center justify-between mb-4 sm:mb-6">
                <h3 class="text-xl sm:text-2xl font-bold text-gray-800">기록 수정</h3>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="space-y-3 sm:space-y-4">
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">날짜</label>
                    <input type="date" id="editDate" class="w-full px-3 py-2 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">출근 시간</label>
                    <input type="time" id="editStartTime" class="w-full px-3 py-2 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">퇴근 시간</label>
                    <input type="time" id="editEndTime" class="w-full px-3 py-2 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
                <div class="flex gap-3 pt-2 sm:pt-4">
                    <button onclick="saveEdit()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 sm:py-3 rounded-lg transition duration-200 text-sm sm:text-base">저장</button>
                    <button onclick="closeEditModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 sm:py-3 rounded-lg transition duration-200 text-sm sm:text-base">취소</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAbYEki5kraulyXH6iHfbMi5LbVmvlVZu0",
            authDomain: "hong39-9cf7f.firebaseapp.com",
            projectId: "hong39-9cf7f",
            storageBucket: "hong39-9cf7f.firebasestorage.app",
            messagingSenderId: "927700556500",
            appId: "1:927700556500:web:9fd8f4b2e8c971b8677941"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let records = [];
        let editingId = null;

        function showLoading() { document.getElementById('loading').classList.add('active'); }
        function hideLoading() { document.getElementById('loading').classList.remove('active'); }

        function formatHoursToText(hours) {
            const hVal = parseFloat(hours);
            if (isNaN(hVal)) return "0시간";
            const totalMinutes = Math.round(hVal * 60);
            const h = Math.floor(totalMinutes / 60);
            const m = totalMinutes % 60;
            if (m === 0) return `${h}시간`;
            return `${h}시간 ${m}분`;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
            const dayOfWeek = dayNames[date.getDay()];
            return `${month}/${day}(${dayOfWeek})`;
        }

        async function loadRecords() {
            showLoading();
            try {
                const snapshot = await db.collection('attendance').orderBy('date', 'desc').get();
                records = [];
                snapshot.forEach(doc => { records.push({ id: doc.id, ...doc.data() }); });
            } catch (error) {
                console.error("데이터 로드 오류:", error);
            } finally {
                hideLoading();
            }
        }

        async function addRecord() {
            const date = document.getElementById('dateInput').value;
            const startTime = document.getElementById('startTimeInput').value;
            const endTime = document.getElementById('endTimeInput').value;
            if (!date || !startTime || !endTime) { alert('항목을 입력하세요.'); return; }
            const start = new Date(`${date}T${startTime}`);
            const end = new Date(`${date}T${endTime}`);
            if (end <= start) { alert('시간 설정 오류'); return; }
            const hours = ((end - start) / (1000 * 60 * 60)).toFixed(2);
            showLoading();
            try {
                await db.collection('attendance').add({ date, startTime, endTime, hours, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                await loadRecords();
                updateDashboard();
            } catch (e) { console.error(e); } finally { hideLoading(); }
        }

        function openEditModal(id) {
            const record = records.find(r => r.id === id);
            if (!record) return;
            editingId = id;
            document.getElementById('editDate').value = record.date;
            document.getElementById('editStartTime').value = record.startTime;
            document.getElementById('editEndTime').value = record.endTime;
            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            editingId = null;
            document.getElementById('editModal').classList.remove('active');
        }

        async function saveEdit() {
            const date = document.getElementById('editDate').value;
            const startTime = document.getElementById('editStartTime').value;
            const endTime = document.getElementById('editEndTime').value;
            const start = new Date(`${date}T${startTime}`);
            const end = new Date(`${date}T${endTime}`);
            const hours = ((end - start) / (1000 * 60 * 60)).toFixed(2);
            showLoading();
            try {
                await db.collection('attendance').doc(editingId).update({ date, startTime, endTime, hours });
                await loadRecords();
                updateDashboard();
                closeEditModal();
            } catch (e) { console.error(e); } finally { hideLoading(); }
        }

        async function deleteRecord(id) {
            if (!confirm('삭제하시겠습니까?')) return;
            showLoading();
            try {
                await db.collection('attendance').doc(id).delete();
                await loadRecords();
                updateDashboard();
            } catch (e) { console.error(e); } finally { hideLoading(); }
        }

        function exportToExcel() {
            if (records.length === 0) return;
            const sorted = [...records].sort((a, b) => new Date(a.date) - new Date(b.date));
            const data = sorted.map(r => ({ '날짜': r.date, '출근': r.startTime, '퇴근': r.endTime, '시간': parseFloat(r.hours) }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '기록');
            XLSX.writeFile(wb, `근무기록.xlsx`);
        }

        function generateMonthOptions() {
            const select = document.getElementById('monthSelect');
            select.innerHTML = '';
            const startDate = new Date(2024, 11, 1);
            const current = new Date();
            let d = new Date(startDate);
            while (d <= new Date(current.getFullYear(), current.getMonth() + 12, 1)) {
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const opt = document.createElement('option');
                opt.value = `${y}-${m}`;
                opt.textContent = `${y}년 ${m}월`;
                if (y === current.getFullYear() && d.getMonth() === current.getMonth()) opt.selected = true;
                select.appendChild(opt);
                d.setMonth(d.getMonth() + 1);
            }
        }

        function renderCalendar(year, month, monthRecords) {
            // 달력 제목 동적 변경
            document.getElementById('calendarTitle').textContent = `${year}년 ${month}월 근무 달력`;
            
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            const days = ['일', '월', '화', '수', '목', '금', '토'];
            days.forEach(d => {
                const h = document.createElement('div');
                h.className = `day-header ${d === '일' ? 'text-red-500' : d === '토' ? 'text-blue-500' : 'text-gray-600'}`;
                h.textContent = d;
                grid.appendChild(h);
            });
            const first = new Date(year, month - 1, 1).getDay();
            const last = new Date(year, month, 0).getDate();
            for (let i = 0; i < first; i++) {
                const e = document.createElement('div');
                e.className = 'calendar-day bg-gray-50';
                grid.appendChild(e);
            }
            for (let d = 1; d <= last; d++) {
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dow = new Date(year, month - 1, d).getDay();
                const el = document.createElement('div');
                el.className = 'calendar-day';
                let color = 'text-gray-800';
                if (dow === 0) color = 'text-red-500';
                else if (dow === 6) color = 'text-blue-500';
                const span = document.createElement('span');
                span.className = `text-sm font-semibold ${color}`;
                span.textContent = d;
                if (monthRecords.some(r => r.date === dateStr)) {
                    span.className = 'attendance-circle text-sm font-bold';
                }
                el.appendChild(span);
                grid.appendChild(el);
            }
        }

        function updateDashboard() {
            const selectedMonth = document.getElementById('monthSelect').value;
            const [year, month] = selectedMonth.split('-').map(Number);
            
            // 월별 데이터
            const monthRecords = records.filter(r => {
                const d = new Date(r.date);
                return d.getFullYear() === year && d.getMonth() + 1 === month;
            });
            renderCalendar(year, month, monthRecords);

            // 누적 데이터 (2024년 12월 1일부터 선택한 월의 마지막 날까지)
            const baseDate = new Date(2024, 11, 1);
            const lastDayOfMonth = new Date(year, month, 0);
            const cumulativeRecords = records.filter(r => {
                const rd = new Date(r.date);
                return rd >= baseDate && rd <= lastDayOfMonth;
            });

            const mDays = monthRecords.length;
            const mHours = monthRecords.reduce((s, r) => s + parseFloat(r.hours), 0);
            
            const cDays = cumulativeRecords.length;
            const cHours = cumulativeRecords.reduce((s, r) => s + parseFloat(r.hours), 0);

            document.getElementById('monthDays').textContent = `${mDays}일`;
            document.getElementById('expectedSalary').textContent = `${(mDays * 50000).toLocaleString()}원`;
            document.getElementById('monthTotalHours').textContent = formatHoursToText(mHours);
            document.getElementById('monthAvgHours').textContent = formatHoursToText(mDays > 0 ? (mHours / mDays).toFixed(2) : 0);
            
            // 누적 일 평균 수정 (정상적인 평균 계산)
            document.getElementById('cumulativeAvgHours').textContent = formatHoursToText(cDays > 0 ? (cHours / cDays).toFixed(2) : 0);
            
            document.getElementById('monthTitle').textContent = `${year}년 ${month}월 출근 기록`;
            
            const list = document.getElementById('recordsList');
            if (mDays === 0) {
                list.innerHTML = '<div class="text-center py-8 text-gray-500 text-sm">기록 없음</div>';
            } else {
                list.innerHTML = monthRecords.sort((a,b)=>new Date(a.date)-new Date(b.date)).map((r, i) => `
                    <div class="bg-white rounded-lg p-3 shadow-sm flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="bg-indigo-600 text-white rounded-lg w-8 h-8 flex items-center justify-center font-bold text-xs">${i+1}</div>
                            <div>
                                <div class="font-semibold text-sm">${formatDate(r.date)}</div>
                                <div class="text-xs text-gray-500">${r.startTime}~${r.endTime} (${formatHoursToText(r.hours)})</div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openEditModal('${r.id}')" class="text-blue-500 text-xs font-bold px-2 py-1 bg-blue-50 rounded">수정</button>
                            <button onclick="deleteRecord('${r.id}')" class="text-red-500 text-xs font-bold px-2 py-1 bg-red-50 rounded">삭제</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        window.onload = async function() {
            generateMonthOptions();
            await loadRecords();
            updateDashboard();
        };
    </script>
</body>
</html>오후 3:46 2025-12-19 (금)
