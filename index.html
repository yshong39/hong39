<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>돌봄선생님 근무표</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 14px;
        }
        @media (min-width: 640px) {
            body { font-size: 16px; }
        }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .loading { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 2000; }
        .loading.active { display: block; }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
    <div id="loading" class="loading">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
            <p class="text-gray-700 font-medium">데이터 로딩 중...</p>
        </div>
    </div>

    <div class="max-w-6xl mx-auto">
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    <h1 class="text-3xl font-bold text-gray-800">돌봄선생님 근무표</h1>
                </div>
                <button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-200 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    엑셀 다운로드
                </button>
            </div>

            <div class="bg-gradient-to-r from-indigo-50 to-blue-50 rounded-xl p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    출퇴근 기록 입력
                </h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">날짜</label>
                        <input type="date" id="dateInput" class="w-full px-3 py-2 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">출근 시간</label>
                        <input type="time" id="startTimeInput" class="w-full px-3 py-2 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">퇴근 시간</label>
                        <input type="time" id="endTimeInput" class="w-full px-3 py-2 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    <div class="flex items-end">
                        <button onclick="addRecord()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 sm:px-6 rounded-lg transition duration-200 flex items-center justify-center gap-2 text-sm sm:text-base">
                            <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            추가
                        </button>
                    </div>
                </div>
            </div>

            <div class="mb-6 sm:mb-8">
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 sm:mb-6 gap-3">
                    <h2 class="text-base sm:text-xl font-semibold text-gray-800 flex items-center gap-2">
                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <line x1="18" y1="20" x2="18" y2="10"></line>
                            <line x1="12" y1="20" x2="12" y2="4"></line>
                            <line x1="6" y1="20" x2="6" y2="14"></line>
                        </svg>
                        근무 현황 대시보드
                    </h2>
                    <div class="w-full sm:w-auto">
                        <select id="monthSelect" onchange="updateDashboard()" class="w-full px-3 py-2 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-medium"></select>
                    </div>
                </div>

                <div class="grid grid-cols-2 lg:grid-cols-5 gap-2 sm:gap-4 mb-4 sm:mb-6">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg sm:rounded-xl p-3 sm:p-6 text-white">
                        <div class="text-xs sm:text-sm font-medium opacity-90 mb-1 sm:mb-2">출근 일수</div>
                        <div class="text-xl sm:text-3xl font-bold" id="monthDays">0일</div>
                    </div>
                    <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-lg sm:rounded-xl p-3 sm:p-6 text-white">
                        <div class="text-xs sm:text-sm font-medium opacity-90 mb-1">지급 예정 급여</div>
                        <div class="text-xs opacity-80 mb-1">(5만원/일)</div>
                        <div class="text-lg sm:text-3xl font-bold" id="expectedSalary">0원</div>
                    </div>
                    <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-lg sm:rounded-xl p-3 sm:p-6 text-white col-span-2 lg:col-span-1">
                        <div class="text-xs sm:text-sm font-medium opacity-90 mb-1 sm:mb-2">총 근무시간</div>
                        <div class="text-xl sm:text-3xl font-bold" id="monthTotalHours">0시간</div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg sm:rounded-xl p-3 sm:p-6 text-white">
                        <div class="text-xs sm:text-sm font-medium opacity-90 mb-1 sm:mb-2">월 일평균</div>
                        <div class="text-xl sm:text-3xl font-bold" id="monthAvgHours">0시간</div>
                    </div>
                    <div class="bg-gradient-to-br from-pink-500 to-pink-600 rounded-lg sm:rounded-xl p-3 sm:p-6 text-white">
                        <div class="text-xs sm:text-sm font-medium opacity-90 mb-1 sm:mb-2">누적 일평균</div>
                        <div class="text-xl sm:text-3xl font-bold" id="cumulativeAvgHours">0시간</div>
                        <div class="text-xs opacity-80 mt-1">2025.12~</div>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-lg sm:rounded-xl p-4 sm:p-6">
                    <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-3 sm:mb-4" id="monthTitle">2025년 12월 출근 기록</h3>
                    <div id="recordsList" class="space-y-2 max-h-80 overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="bg-white rounded-xl sm:rounded-2xl shadow-2xl p-6 sm:p-8 max-w-md w-full mx-4">
            <div class="flex items-center justify-between mb-4 sm:mb-6">
                <h3 class="text-xl sm:text-2xl font-bold text-gray-800">출근 기록 수정</h3>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="space-y-3 sm:space-y-4">
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">날짜</label>
                    <input type="date" id="editDate" class="w-full px-3 py-2 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">출근 시간</label>
                    <input type="time" id="editStartTime" class="w-full px-3 py-2 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">퇴근 시간</label>
                    <input type="time" id="editEndTime" class="w-full px-3 py-2 text-sm sm:text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
                <div class="flex gap-3 pt-2 sm:pt-4">
                    <button onclick="saveEdit()" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 sm:py-3 rounded-lg transition duration-200 text-sm sm:text-base">저장</button>
                    <button onclick="closeEditModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 sm:py-3 rounded-lg transition duration-200 text-sm sm:text-base">취소</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAbYEki5kraulyXH6iHfbMi5LbVmvlVZu0",
            authDomain: "hong39-9cf7f.firebaseapp.com",
            projectId: "hong39-9cf7f",
            storageBucket: "hong39-9cf7f.firebasestorage.app",
            messagingSenderId: "927700556500",
            appId: "1:927700556500:web:9fd8f4b2e8c971b8677941"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let records = [];
        let editingId = null;

        function showLoading() { document.getElementById('loading').classList.add('active'); }
        function hideLoading() { document.getElementById('loading').classList.remove('active'); }

        function formatHoursToText(hours) {
            const totalMinutes = Math.round(parseFloat(hours) * 60);
            const h = Math.floor(totalMinutes / 60);
            const m = totalMinutes % 60;
            if (m === 0) return `${h}시간`;
            return `${h}시간 ${m}분`;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
            const dayOfWeek = dayNames[date.getDay()];
            return `${month}/${day}(${dayOfWeek})`;
        }

        async function loadRecords() {
            showLoading();
            try {
                const snapshot = await db.collection('attendance').orderBy('date', 'desc').get();
                records = [];
                snapshot.forEach(doc => { records.push({ id: doc.id, ...doc.data() }); });
            } catch (error) {
                console.error("데이터 로드 오류:", error);
                alert("데이터를 불러오는데 실패했습니다.");
            } finally {
                hideLoading();
            }
        }

        async function addRecord() {
            const date = document.getElementById('dateInput').value;
            const startTime = document.getElementById('startTimeInput').value;
            const endTime = document.getElementById('endTimeInput').value;

            if (!date || !startTime || !endTime) { alert('모든 항목을 입력해주세요.'); return; }

            const start = new Date(`${date}T${startTime}`);
            const end = new Date(`${date}T${endTime}`);
            if (end <= start) { alert('퇴근 시간은 출근 시간보다 늦어야 합니다.'); return; }

            const hours = ((end - start) / (1000 * 60 * 60)).toFixed(2);
            const newRecord = { date, startTime, endTime, hours, timestamp: firebase.firestore.FieldValue.serverTimestamp() };

            showLoading();
            try {
                await db.collection('attendance').add(newRecord);
                await loadRecords();
                document.getElementById('dateInput').value = '';
                document.getElementById('startTimeInput').value = '';
                document.getElementById('endTimeInput').value = '';
                updateDashboard();
            } catch (error) {
                console.error("저장 오류:", error);
                alert("데이터 저장에 실패했습니다.");
            } finally {
                hideLoading();
            }
        }

        function openEditModal(id) {
            const record = records.find(r => r.id === id);
            if (!record) return;
            editingId = id;
            document.getElementById('editDate').value = record.date;
            document.getElementById('editStartTime').value = record.startTime;
            document.getElementById('editEndTime').value = record.endTime;
            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            editingId = null;
            document.getElementById('editModal').classList.remove('active');
        }

        async function saveEdit() {
            if (!editingId) return;
            const date = document.getElementById('editDate').value;
            const startTime = document.getElementById('editStartTime').value;
            const endTime = document.getElementById('editEndTime').value;

            if (!date || !startTime || !endTime) { alert('모든 항목을 입력해주세요.'); return; }

            const start = new Date(`${date}T${startTime}`);
            const end = new Date(`${date}T${endTime}`);
            if (end <= start) { alert('퇴근 시간은 출근 시간보다 늦어야 합니다.'); return; }

            const hours = ((end - start) / (1000 * 60 * 60)).toFixed(2);

            showLoading();
            try {
                await db.collection('attendance').doc(editingId).update({ date, startTime, endTime, hours });
                await loadRecords();
                updateDashboard();
                closeEditModal();
            } catch (error) {
                console.error("수정 오류:", error);
                alert("데이터 수정에 실패했습니다.");
            } finally {
                hideLoading();
            }
        }

        async function deleteRecord(id) {
            if (!confirm('이 기록을 삭제하시겠습니까?')) return;
            showLoading();
            try {
                await db.collection('attendance').doc(id).delete();
                await loadRecords();
                updateDashboard();
            } catch (error) {
                console.error("삭제 오류:", error);
                alert("데이터 삭제에 실패했습니다.");
            } finally {
                hideLoading();
            }
        }

        function exportToExcel() {
            if (records.length === 0) { alert('다운로드할 출근 기록이 없습니다.'); return; }
            const sortedRecords = [...records].sort((a, b) => new Date(a.date) - new Date(b.date));
            const excelData = sortedRecords.map(record => ({
                '날짜': record.date,
                '출근시간': record.startTime,
                '퇴근시간': record.endTime,
                '근무시간': parseFloat(record.hours)
            }));
            const worksheet = XLSX.utils.json_to_sheet(excelData);
            worksheet['!cols'] = [{ wch: 12 }, { wch: 10 }, { wch: 10 }, { wch: 10 }];
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, '출근기록');
            const today = new Date().toISOString().split('T')[0];
            XLSX.writeFile(workbook, `돌봄선생님_출근기록_${today}.xlsx`);
        }

        function generateMonthOptions() {
            const select = document.getElementById('monthSelect');
            select.innerHTML = '';
            const startDate = new Date(2025, 11, 1);
            const currentDate = new Date();
            const endDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 12, 1);
            let date = new Date(startDate);
            while (date <= endDate) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const value = `${year}-${month}`;
                const option = document.createElement('option');
                option.value = value;
                option.textContent = `${year}년 ${month}월`;
                select.appendChild(option);
                date.setMonth(date.getMonth() + 1);
            }
        }

        function updateDashboard() {
            const selectedMonth = document.getElementById('monthSelect').value;
            const [year, month] = selectedMonth.split('-').map(Number);
            const monthRecords = records.filter(r => {
                const recordDate = new Date(r.date);
                return recordDate.getFullYear() === year && recordDate.getMonth() + 1 === month;
            });
            const startDate = new Date(2025, 11, 1);
            const endDate = new Date(year, month - 1, 31);
            const cumulativeRecords = records.filter(r => {
                const recordDate = new Date(r.date);
                return recordDate >= startDate && recordDate <= endDate;
            });
            const monthDays = monthRecords.length;
            const monthTotalHours = monthRecords.reduce((sum, r) => sum + parseFloat(r.hours), 0);
            const monthAvgHours = monthDays > 0 ? (monthTotalHours / monthDays).toFixed(2) : '0.00';
            const expectedSalary = monthDays * 50000;
            const cumulativeDays = cumulativeRecords.length;
            const cumulativeTotalHours = cumulativeRecords.reduce((sum, r) => sum + parseFloat(r.hours), 0);
            const cumulativeAvgHours = cumulativeDays > 0 ? (cumulativeTotalHours / cumulativeDays).toFixed(2) : '0.00';
            document.getElementById('monthDays').textContent = `${monthDays}일`;
            document.getElementById('expectedSalary').textContent = `${expectedSalary.toLocaleString('ko-KR')}원`;
            document.getElementById('monthTotalHours').textContent = formatHoursToText(monthTotalHours);
            document.getElementById('monthAvgHours').textContent = formatHoursToText(monthAvgHours);
            document.getElementById('cumulativeAvgHours').textContent = formatHoursToText(cumulativeAvgHours);
            document.getElementById('monthTitle').textContent = `${year}년 ${month}월 출근 기록`;
            const recordsList = document.getElementById('recordsList');
            if (monthRecords.length === 0) {
                recordsList.innerHTML = '<div class="text-center py-8 text-gray-500 text-sm">선택한 월에 출근 기록이 없습니다.</div>';
            } else {
                const sortedMonthRecords = [...monthRecords].sort((a, b) => new Date(a.date) - new Date(b.date));
                recordsList.innerHTML = sortedMonthRecords.map((record, index) => {
                    return `
                    <div class="bg-white rounded-lg p-3 sm:p-4 flex items-center justify-between shadow-sm hover:shadow-md transition">
                        <div class="flex items-center gap-2 sm:gap-4 flex-1">
                            <div class="bg-indigo-600 text-white rounded-lg w-8 h-8 sm:w-12 sm:h-12 flex items-center justify-center font-bold text-sm sm:text-lg flex-shrink-0">${index + 1}</div>
                            <div class="text-center flex-shrink-0">
                                <div class="text-xs sm:text-sm text-gray-500">날짜</div>
                                <div class="font-semibold text-gray-800 text-sm sm:text-base">${formatDate(record.date)}</div>
                            </div>
                            <div class="hidden sm:block h-10 sm:h-14 w-px bg-gray-200"></div>
                            <div class="flex items-center gap-1 sm:gap-2 flex-shrink-0">
                                <svg class="w-3 h-3 sm:w-4 sm:h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg>
                                <span class="text-gray-700 text-xs sm:text-sm">${record.startTime}~${record.endTime}</span>
                            </div>
                            <div class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full text-xs sm:text-sm font-medium flex-shrink-0">${formatHoursToText(record.hours)}</div>
                        </div>
                        <div class="flex gap-1 sm:gap-2 ml-2">
                            <button onclick="openEditModal('${record.id}')" class="text-blue-500 hover:text-blue-700 p-1 sm:p-2 rounded-lg hover:bg-blue-50 transition" title="수정">
                                <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                            <button onclick="deleteRecord('${record.id}')" class="text-red-500 hover:text-red-700 p-1 sm:p-2 rounded-lg hover:bg-red-50 transition" title="삭제">
                                <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `}).join('');
            }
        }

        window.onload = async function() {
            await loadRecords();
            generateMonthOptions();
            updateDashboard();
        };
    </script>
</body>
</html>